blueprint:
  name: Window - Heating Control (Open/Close/Forgotten) [WHC]
  description: |
    ## ðŸŒ¡ï¸ Window Heating Control (WHC) V2.0
    Optimisez votre consommation d'Ã©nergie en automatisant l'arrÃªt du chauffage lors de l'ouverture des fenÃªtres.

    ### ðŸ› ï¸ FonctionnalitÃ©s :
    - **Sauvegarde d'Ã©tat :** MÃ©morise le mode et la tempÃ©rature via une scÃ¨ne dynamique.
    - **Restauration intelligente :** Relance le chauffage Ã  la fermeture (avec sÃ©curitÃ© anti-crash).
    - **Alerte "Oubli" :** Notification prioritaire si la fenÃªtre reste ouverte trop longtemps.
    - **Optimisation :** Ne s'exÃ©cute pas si le chauffage est dÃ©jÃ  Ã©teint.
    - **Notifications :** Alertes multilingues (FR/EN) avec tempÃ©rature extÃ©rieure, heure et lien direct.

    [Documentation & Support](https://github.com/rirethy/WindowHeatingControl)
  domain: automation
  input:
    window_sensor:
      name: Capteur de fenÃªtre
      selector:
        entity:
          domain: binary_sensor
    climate_entities:
      name: Thermostats
      selector:
        entity:
          domain: climate
          multiple: true
    notify_devices:
      name: Appareils de notification (optionnel)
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true
    dashboard_path:
      name: Chemin au clic (Notification)
      default: "/lovelace"
    room_name:
      name: Nom de la piÃ¨ce
    window_opened_flag:
      name: Boolean d'Ã©tat (Flag)
      selector:
        entity:
          domain: input_boolean
    window_open_duration:
      name: DÃ©lai avant coupure chauffage suite Ã  ouverture fenÃªtre (Secondes)
      default: 45
      selector:
        number:
          min: 5
          max: 600
          unit_of_measurement: seconds
    window_forgotten_duration:
      name: DÃ©lai avant alerte oubli fenÃªtre restÃ©e ouverte (Minutes)
      default: 30
      selector:
        number:
          min: 5
          max: 120
          unit_of_measurement: minutes
    window_close_duration:
      name: DÃ©lai avant remise en route chauffage suite Ã  fermeture fenÃªtre (Minutes)
      default: 15
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: minutes
    temperature_sensor:
      name: Capteur de tempÃ©rature extÃ©rieure
      selector:
        entity:
          domain: sensor
    language:
      name: Langue
      default: fr
      selector:
        language:
          languages: [en, fr]

variables:
  room_name: !input room_name
  climate_entities: !input climate_entities
  notify_devices: !input notify_devices
  window_opened_flag: !input window_opened_flag
  temperature_sensor: !input temperature_sensor
  language: !input language
  dashboard_path: !input dashboard_path
  current_temp: "{{ states(temperature_sensor) if states(temperature_sensor) not in ['unknown', 'unavailable'] else '?' }}"
  unit: "{{ state_attr(temperature_sensor, 'unit_of_measurement') | default('Â°C') }}"
  scene_id: "heating_before_{{ room_name | slugify }}"
  txt:
    fr:
      title: "Gestion du chauffage"
      stop: "Chauffage arrÃªtÃ© dans"
      resume: "Chauffage rallumÃ© dans"
      outside: "dehors"
      forgotten: "âš ï¸ FenÃªtre oubliÃ©e ouverte :"
    en:
      title: "Heating Management"
      stop: "Heating stopped in"
      resume: "Heating resumed in"
      outside: "outside"
      forgotten: "âš ï¸ Window left open in:"

trigger:
  - platform: state
    entity_id: !input window_sensor
    to: "on"
    for:
      seconds: !input window_open_duration
    id: "open"
  - platform: state
    entity_id: !input window_sensor
    to: "off"
    for:
      minutes: !input window_close_duration
    id: "closed"
  - platform: state
    entity_id: !input window_sensor
    to: "on"
    for:
      minutes: !input window_forgotten_duration
    id: "forgotten"

action:
  - choose:
      # --- OUVERTURE ---
      - conditions:
          - condition: trigger
            id: "open"
          - condition: template
            value_template: "{{ expand(climate_entities) | selectattr('state', 'ne', 'off') | list | length > 0 }}"
        sequence:
          - action: scene.create
            data:
              scene_id: "{{ scene_id }}"
              snapshot_entities: "{{ climate_entities }}"
          - action: input_boolean.turn_on
            target:
              entity_id: !input window_opened_flag
          - action: climate.set_hvac_mode
            target:
              entity_id: "{{ climate_entities }}"
            data:
              hvac_mode: "off"
          - if:
              - condition: template
                value_template: "{{ notify_devices | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devices }}"
                  sequence:
                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                      data:
                        title: "{{ txt[language].title }}"
                        message: "{{ txt[language].stop }} {{ room_name }}, {{ current_temp }}{{ unit }} {{ txt[language].outside }} ({{ now().strftime('%H:%M') }})"
                        data:
                          clickAction: "{{ dashboard_path }}"
                          url: "{{ dashboard_path }}"

      # --- FERMETURE (Avec sÃ©curitÃ© redÃ©marrage) ---
      - conditions:
          - condition: trigger
            id: "closed"
          - condition: state
            entity_id: !input window_opened_flag
            state: "on"
        sequence:
          - action: input_boolean.turn_off
            target:
              entity_id: !input window_opened_flag

          # 1. Tentative de restauration de la scÃ¨ne
          - continue_on_error: true
            action: scene.turn_on
            target:
              entity_id: "scene.{{ scene_id }}"

          # 2. SÃ©curitÃ© Fallback : Si les thermostats sont toujours sur OFF (scÃ¨ne perdue), on force AUTO
          - if:
              - condition: template
                value_template: "{{ expand(climate_entities) | selectattr('state', 'eq', 'off') | list | length > 0 }}"
            then:
              - action: climate.set_hvac_mode
                target:
                  entity_id: "{{ climate_entities }}"
                data:
                  hvac_mode: "auto"

          - if:
              - condition: template
                value_template: "{{ notify_devices | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devices }}"
                  sequence:
                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                      data:
                        title: "{{ txt[language].title }}"
                        message: "{{ txt[language].resume }} {{ room_name }}, {{ current_temp }}{{ unit }} {{ txt[language].outside }} ({{ now().strftime('%H:%M') }})"
                        data:
                          clickAction: "{{ dashboard_path }}"
                          url: "{{ dashboard_path }}"

      # --- OUBLI ---
      - conditions:
          - condition: trigger
            id: "forgotten"
        sequence:
          - if:
              - condition: template
                value_template: "{{ notify_devices | length > 0 }}"
            then:
              - repeat:
                  for_each: "{{ notify_devices }}"
                  sequence:
                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                      data:
                        title: "OUBLI FENÃŠTRE"
                        message: "{{ txt[language].forgotten }} {{ room_name }}"
                        data:
                          priority: high
                          ttl: 0
                          color: "#e74c3c"
                          clickAction: "{{ dashboard_path }}"
                          url: "{{ dashboard_path }}"

mode: restart
